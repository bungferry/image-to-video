<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Konversi Gambar ke Video (.mp4)</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
    /* 1. Layout Responsif & Tema Terang */
    body { 
        font-family: system-ui, sans-serif; 
        background: #f0f0f0; 
        color: #333; 
        display:flex; 
        flex-direction:column; 
        align-items:center; 
        justify-content:center; 
        min-height:100%; 
        margin:0; 
        padding: 20px;
    }
    .container { 
        width: 100%; 
        max-width: 900px; 
        display: flex; 
        flex-wrap: wrap; 
        gap: 20px; 
    }
    .card { 
        background: #ffffff; 
        padding:20px; 
        border-radius:12px; 
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        flex: 1 1 300px; 
        min-width: 300px;
        min-height: 200px; 
        box-sizing: border-box;
    }
    h2 { margin-top: 0; text-align: center; color: #111; }

    /* 2. Drop Area/Preview Container (Rasio 1:1) */
    #dropArea {
        border: 2px dashed #0078ff; 
        border-radius: 8px;
        color: #666; 
        cursor: pointer;
        display: block; 
        text-align: center;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        width: 100%;
        padding-top: 100%; 
        transition: border 0.2s ease-in-out;
    }
    
    /* Hilangkan border saat preview muncul */
    #dropArea.border-hidden {
        border: 2px solid transparent; 
    }

    #dropArea:not(.disabled):hover {
        background: #e9e9e9; 
    }
    #dropArea.disabled {
        cursor: default;
    }
    .drop-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-sizing: border-box;
        transition: opacity 0.3s;
    }
    #image { display: none; } 
    #previewImage, #videoPreview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 8px;
        display: none;
        object-fit: cover;
    }
    #previewImage {
        object-fit: contain;
    }

    /* KONTROL STATUS PROSES DI TENGAH PREVIEW */
    #processingOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        color: #111; 
        display: none; 
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 15;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: bold;
    }

    /* KONTROL TOMBOL UNDUH DAN BAGIKAN (CONTAINER) */
    .action-buttons {
        position: absolute; 
        top: 15px;      /* Pindah ke atas */
        right: 15px;    /* Tetap di kanan */
        display: flex;
        gap: 8px;
        z-index: 10; 
    }
    
    /* GAYA TOMBOL (Unduh & Bagikan) */
    .action-buttons button { 
        background: rgba(255, 255, 255, 0.7);
        border: none; 
        color: #121212; 
        padding: 0; 
        width: 30px; 
        height: 30px; 
        border-radius: 50%; 
        cursor: pointer; 
        font-size: 1em; 
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background 0.3s ease;
    }
    .action-buttons button:hover {
        background: rgba(255, 255, 255, 0.9);
    }
    .action-buttons button:disabled { background:#ccc; cursor:not-allowed; color: #666; }


    /* LAYOUT KONTROL BAWAH */
    .controls-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
    }
    .controls-group {
        display: flex;
        gap: 10px;
    }
    .controls-group > div {
        display: flex;
        flex-direction: column;
    }
    
    /* Tombol Buat Video (Fleksibel) */
    #convertBtn { 
        background:#0078ff; 
        border:none; 
        color:white; 
        padding:10px 15px; 
        border-radius:8px; 
        cursor:pointer; 
        font-weight: bold;
        flex-grow: 1; 
        min-width: 120px;
        height: 40px;
        align-self: flex-end;
    }
    #convertBtn:disabled { background:#aaa; cursor:not-allowed; }
    
    /* Gaya untuk dropdown */
    select { 
        padding: 8px; 
        border-radius: 4px; 
        border: 1px solid #ccc; 
        background: #f9f9f9; 
        color: #333; 
        box-sizing: border-box; 
        height: 40px;
    }
    label { 
        font-size: 0.8em; 
        color: #666; 
        margin-bottom: 2px;
        text-align: left;
    }
    
    /* Status bawah */
    .progress { margin-top:15px; font-size:0.9em; opacity:0.7; color: #333; }
    
    /* Adaptasi responsif */
    @media (max-width: 600px) {
        .controls-container {
            flex-direction: column;
            align-items: stretch;
        }
        .controls-group {
            width: 100%;
            justify-content: space-between;
        }
        .controls-group > div {
            flex: 1;
        }
        #convertBtn {
            margin-top: 10px;
            width: 100%;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <div class="card" style="flex: 2 1 400px;">
        <h2>Konversi Gambar ke Video</h2>
        <input type="file" id="image" accept="image/*" />
        
        <div id="dropArea">
            
            <div class="drop-content" id="initialContent">
                <span>Klik atau Drop Gambar di Sini</span>
                <small>Rasio aspek visual 1:1</small>
            </div>
            
            <img id="previewImage" src="" alt="Preview Gambar" />
            <video id="videoPreview" controls muted></video>
            
            <div id="processingOverlay">
                <i class="fas fa-spinner fa-spin" style="margin-bottom: 10px;"></i>
                <span id="processingStatusText">Sedang diproses, tunggu sebentar...</span>
            </div>

            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button id="shareButton" title="Bagikan Video"><i class="fas fa-share-alt"></i></button>
                <button id="downloadButton" title="Unduh Video"><i class="fas fa-download"></i></button>
            </div>

        </div>
        
        <div class="controls-container">
            
            <button id="convertBtn"><i class="fas fa-video"></i> Buat Video</button>
            
            <div class="controls-group">
                <div>
                    <label for="resolution">Rasio Aspek</label>
                    <select id="resolution">
                        
                        <option value="1200x630">Facebook (1.91:1 - Link)</option>
                        <option value="1080x1350">Instagram (4:5 - Feed)</option>
                        <option value="1080x1920">9:16 (Reels/Status)</option>
                        
                        <option value="1080x1080">1:1 (Square - Universal)</option>
                        <option value="1920x1080">16:9 (YouTube/Landscape)</option>
                    </select>
                </div>
                
                <div>
                    <label for="duration">Durasi (detik)</label>
                    <select id="duration">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="60">60</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="progress" id="status">Pilih gambar dan atur opsi konversi.</div>
    </div>
    
    <div class="card" style="display:none;"></div> 

  </div> <script>
    // --- Elemen DOM ---
    const convertBtn = document.getElementById("convertBtn");
    const imageInput = document.getElementById("image");
    const durationInput = document.getElementById("duration"); 
    const resolutionInput = document.getElementById("resolution");
    const statusEl = document.getElementById("status");
    const dropArea = document.getElementById("dropArea");
    const initialContent = document.getElementById("initialContent");
    const previewImage = document.getElementById("previewImage");
    const videoPreview = document.getElementById("videoPreview");
    
    // Tombol Aksi 
    const actionButtonsContainer = document.getElementById("actionButtons"); // Kontainer
    const downloadButton = document.getElementById("downloadButton"); 
    const shareButton = document.getElementById("shareButton"); 
    
    const processingOverlay = document.getElementById("processingOverlay"); 

    // --- State & Utility ---
    let selectedFile = null;
    let videoUrl = null;

    // Bersihkan dan reset preview
    const cleanup = () => {
      if (videoUrl) {
        URL.revokeObjectURL(videoUrl);
        videoUrl = null;
      }
      previewImage.style.display = 'none';
      videoPreview.style.display = 'none';
      videoPreview.pause();
      videoPreview.removeAttribute('src');
      videoPreview.load();
      videoPreview.removeAttribute('poster'); 
      
      actionButtonsContainer.style.display = 'none'; // Sembunyikan kontainer tombol
      
      processingOverlay.style.display = 'none'; 
      
      // Pastikan border muncul kembali saat cleanup
      dropArea.classList.remove('border-hidden'); 
      
      if (!selectedFile) {
        dropArea.classList.remove('disabled');
        initialContent.style.display = 'flex';
        statusEl.textContent = "Pilih gambar dan atur opsi konversi."; 
      }
    };

    const handleFile = (file) => {
        if (!file || !file.type.startsWith('image/')) {
            alert("Hanya file gambar yang didukung.");
            return;
        }
        
        cleanup(); 
        selectedFile = file;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
            initialContent.style.display = 'none';
        };
        reader.readAsDataURL(file);
    };

    // --- Event Listeners Drop Area & Input ---
    dropArea.addEventListener('click', () => {
        if (!dropArea.classList.contains('disabled')) {
            imageInput.click();
        }
    });

    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            handleFile(e.target.files[0]);
        }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
      if (!dropArea.classList.contains('disabled')) {
        document.body.addEventListener(eventName, preventDefaults, false);
      }
    });

    function preventDefaults (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    dropArea.addEventListener('drop', (e) => {
        if (dropArea.classList.contains('disabled')) return;
        let dt = e.dataTransfer;
        let files = dt.files;
        if (files.length) {
            handleFile(files[0]);
        }
    }, false);


    // --- Logika Tombol Bagikan Baru ---
    shareButton.onclick = () => {
        if (!videoUrl) {
            alert("Video belum tersedia untuk dibagikan.");
            return;
        }

        // Ambil Blob video dari URL untuk dibagikan
        fetch(videoUrl)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], 'video-konversi.mp4', { type: 'video/mp4' });
                
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    // Menggunakan Web Share API
                    navigator.share({
                        files: [file],
                        title: 'Video Konversi',
                        text: 'Cek video keren yang saya buat!',
                    })
                    .catch((error) => console.error('Error sharing:', error));
                } else {
                    alert("Browser Anda tidak mendukung Web Share API untuk file. Silakan unduh manual.");
                }
            })
            .catch(err => alert("Gagal mengambil data video untuk dibagikan."));
    };
    
    // --- Event Listeners Konversi ---
    convertBtn.onclick = async () => {
      if (!selectedFile) { alert("Pilih atau drop gambar dulu!"); return; }

      const posterBase64 = await new Promise((resolve, reject) => {
          const tempReader = new FileReader();
          tempReader.onload = () => resolve(tempReader.result);
          tempReader.onerror = reject;
          tempReader.readAsDataURL(selectedFile);
      });

      cleanup(); 
      convertBtn.disabled = true;
      
      // Tampilkan Overlay Proses di tengah Preview
      processingOverlay.style.display = 'flex'; 
      statusEl.textContent = ""; 

      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(",")[1];
        const selectedResolution = resolutionInput.value; 
        const selectedDuration = durationInput.value; 

        try {
          // Asumsi /functions/generate sudah fix dan menggunakan fluent-ffmpeg
          const res = await fetch("/.netlify/functions/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              imageBase64: base64, 
              duration: selectedDuration,
              resolution: selectedResolution
            })
          });

          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || "Gagal mengonversi video");
          }

          const blob = await res.blob();
          videoUrl = URL.createObjectURL(blob);
          
          processingOverlay.style.display = 'none';
          
          videoPreview.poster = posterBase64; 
          videoPreview.src = videoUrl;
          
          setTimeout(() => {
              videoPreview.style.display = 'block';
              previewImage.style.display = 'none'; 
              
              actionButtonsContainer.style.display = 'flex'; // Tampilkan kontainer tombol
              
              dropArea.classList.add('disabled'); 
              dropArea.classList.add('border-hidden');
              
              statusEl.textContent = "✅ Selesai! Video siap di-preview dan diunduh/dibagikan.";
          }, 50);

          downloadButton.onclick = () => {
            const a = document.createElement("a");
            a.href = videoUrl;
            a.download = `video-${selectedResolution}-${selectedDuration}s.mp4`; 
            a.click();
          };

        } catch (err) {
          processingOverlay.style.display = 'none'; 
          statusEl.textContent = "❌ Terjadi kesalahan: " + err.message;
          dropArea.classList.remove('disabled'); 
          dropArea.classList.remove('border-hidden'); 
          
          if (previewImage.src) {
              previewImage.style.display = 'block';
          }
        } finally {
          convertBtn.disabled = false;
        }
      };
      reader.readAsDataURL(selectedFile);
    };
  </script>
</body>
  </html>
