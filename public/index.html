<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Konversi Gambar ke Video (.mp4)</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
    /* 1. Layout Responsif */
    body { 
        font-family: system-ui, sans-serif; 
        background:#121212; 
        color:#fff; 
        display:flex; 
        flex-direction:column; 
        align-items:center; 
        justify-content:center; 
        min-height:100vh; 
        margin:0; 
        padding: 20px;
    }
    .container { 
        width: 100%; 
        max-width: 900px; 
        display: flex; 
        flex-wrap: wrap; 
        gap: 20px; 
    }
    .card { 
        background:#1e1e1e; 
        padding:20px; 
        border-radius:12px; 
        flex: 1 1 300px; 
        min-width: 300px;
        min-height: 200px; 
        box-sizing: border-box;
    }
    h2 { margin-top: 0; text-align: center; }

    /* 2. Drop Area/Preview Container (Rasio 1:1) */
    #dropArea {
        border: 2px dashed #0078ff;
        border-radius: 8px;
        color: #aaa;
        cursor: pointer;
        display: block; 
        text-align: center;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        width: 100%;
        padding-top: 100%; 
    }
    #dropArea:not(.disabled):hover {
        background: #2a2a2a;
    }
    #dropArea.disabled {
        cursor: default;
    }
    .drop-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-sizing: border-box;
        transition: opacity 0.3s;
    }

    /* Input File tersembunyi */
    #image { display: none; } 

    /* Preview Gambar/Video */
    #previewImage, #videoPreview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 8px;
        display: none;
    }
    #previewImage {
        object-fit: contain;
    }
    #videoPreview {
        object-fit: cover;
    }

    /* KONTROL STATUS PROSES DI TENGAH PREVIEW */
    #processingOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8); /* Background hitam semi-transparan */
        color: white;
        display: none; /* Awalnya tersembunyi */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 15;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: bold;
    }

    /* KONTROL TOMBOL UNDUH IKON */
    #downloadButton { 
        background: rgba(255, 255, 255, 0.7);
        border: none; 
        color: #121212; 
        padding: 0; 
        width: 40px; 
        height: 40px;
        border-radius: 50%; 
        cursor: pointer; 
        font-size: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute; 
        top: 15px; 
        right: 15px;
        z-index: 10; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background 0.3s ease;
    }
    #downloadButton:hover {
        background: rgba(255, 255, 255, 0.9);
    }
    #downloadButton:disabled { background:#555; cursor:not-allowed; color: #ccc; }

    /* Gaya untuk tombol konversi dan input lainnya */
    .controls { 
        display: flex; 
        flex-direction: column; 
        gap: 15px; 
    }
    label { display: block; margin-top: 5px; text-align: left; }
    select, input[type="range"] { 
        width:100%; 
        padding: 8px; 
        border-radius: 4px; 
        border: 1px solid #333; 
        background: #333; 
        color: white; 
        box-sizing: border-box; 
    }
    #convertBtn { 
        background:#0078ff; 
        border:none; 
        color:white; 
        padding:12px; 
        border-radius:8px; 
        cursor:pointer; 
        width:100%; 
        font-weight: bold;
        margin-top: 15px;
    }
    #convertBtn:disabled { background:#555; cursor:not-allowed; }
    
    /* Status bawah tetap di posisinya */
    .progress { margin-top:15px; font-size:0.9em; opacity:0.8; }
  </style>
</head>
<body>
  <div class="container">
    
    <div class="card" style="flex: 2 1 400px;">
        <h2>Media Upload & Preview</h2>
        <input type="file" id="image" accept="image/*" />
        
        <div id="dropArea">
            
            <div class="drop-content" id="initialContent">
                <span>Klik atau Drop Gambar di Sini</span>
                <small>Rasio aspek visual 1:1</small>
            </div>
            
            <img id="previewImage" src="" alt="Preview Gambar" />
            <video id="videoPreview" controls muted></video>
            
            <div id="processingOverlay">
                <i class="fas fa-spinner fa-spin" style="margin-bottom: 10px;"></i>
                <span id="processingStatusText">Sedang diproses, tunggu sebentar...</span>
            </div>

            <button id="downloadButton" style="display: none;"><i class="fas fa-download"></i></button>
        </div>

        <div class="progress" id="status">Pilih gambar dan atur opsi konversi.</div>
    </div>

    <div class="card">
        <h2>Kontrol Video</h2>
        <div class="controls">
            
            <div>
                <label for="resolution">Rasio Aspek Output:</label>
                <select id="resolution">
                    <option value="1080x1080">1:1 (1080x1080 - Square)</option>
                    <option value="1080x1920">9:16 (1080x1920 - Reels/TikTok)</option>
                    <option value="1920x1080">16:9 (1920x1080 - YouTube)</option>
                </select>
            </div>

            <div>
                <label>Durasi (detik): <span id="durValue">5</span></label>
                <input type="range" id="duration" min="1" max="60" value="5" />
            </div>

            <button id="convertBtn">🎬 Buat Video</button>
        </div>
    </div>

  </div> <script>
    // --- Elemen DOM ---
    const convertBtn = document.getElementById("convertBtn");
    const imageInput = document.getElementById("image");
    const durationInput = document.getElementById("duration");
    const resolutionInput = document.getElementById("resolution");
    const durValue = document.getElementById("durValue");
    const statusEl = document.getElementById("status"); // Status bawah (Sukses/Error)
    const dropArea = document.getElementById("dropArea");
    const initialContent = document.getElementById("initialContent");
    const previewImage = document.getElementById("previewImage");
    const videoPreview = document.getElementById("videoPreview");
    const downloadButton = document.getElementById("downloadButton"); 
    
    // Elemen Overlay Baru
    const processingOverlay = document.getElementById("processingOverlay"); 

    // --- State & Utility ---
    let selectedFile = null;
    let videoUrl = null;

    // Bersihkan dan reset preview
    const cleanup = () => {
      if (videoUrl) {
        URL.revokeObjectURL(videoUrl);
        videoUrl = null;
      }
      previewImage.style.display = 'none';
      videoPreview.style.display = 'none';
      videoPreview.pause();
      videoPreview.removeAttribute('src');
      videoPreview.load();
      videoPreview.removeAttribute('poster'); 
      downloadButton.style.display = 'none'; 
      processingOverlay.style.display = 'none'; // Sembunyikan overlay proses
      
      if (!selectedFile) {
        dropArea.classList.remove('disabled');
        initialContent.style.display = 'flex';
        statusEl.textContent = "Pilih gambar dan atur opsi konversi."; // Reset status bawah
      }
    };

    const handleFile = (file) => {
        if (!file || !file.type.startsWith('image/')) {
            alert("Hanya file gambar yang didukung.");
            return;
        }
        
        cleanup(); 
        selectedFile = file;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
            initialContent.style.display = 'none';
        };
        reader.readAsDataURL(file);
    };

    // --- Event Listeners Drop Area ---
    dropArea.addEventListener('click', () => {
        if (!dropArea.classList.contains('disabled')) {
            imageInput.click();
        }
    });

    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            handleFile(e.target.files[0]);
        }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
      if (!dropArea.classList.contains('disabled')) {
        document.body.addEventListener(eventName, preventDefaults, false);
      }
    });

    function preventDefaults (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    dropArea.addEventListener('drop', (e) => {
        if (dropArea.classList.contains('disabled')) return;
        let dt = e.dataTransfer;
        let files = dt.files;
        if (files.length) {
            handleFile(files[0]);
        }
    }, false);

    // --- Event Listeners Konversi ---
    durationInput.oninput = () => (durValue.textContent = durationInput.value);

    convertBtn.onclick = async () => {
      if (!selectedFile) { alert("Pilih atau drop gambar dulu!"); return; }

      const posterBase64 = await new Promise((resolve, reject) => {
          const tempReader = new FileReader();
          tempReader.onload = () => resolve(tempReader.result);
          tempReader.onerror = reject;
          tempReader.readAsDataURL(selectedFile);
      });

      cleanup(); 
      convertBtn.disabled = true;
      
      // Tampilkan Overlay Proses di tengah Preview
      processingOverlay.style.display = 'flex'; 
      statusEl.textContent = ""; // Kosongkan status di bawah card

      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(",")[1];
        const selectedResolution = resolutionInput.value; 

        try {
          const res = await fetch("/.netlify/functions/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              imageBase64: base64, 
              duration: durationInput.value,
              resolution: selectedResolution
            })
          });

          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || "Gagal mengonversi video");
          }

          const blob = await res.blob();
          videoUrl = URL.createObjectURL(blob);
          
          // Sembunyikan Overlay Proses sebelum menampilkan video
          processingOverlay.style.display = 'none';
          
          videoPreview.poster = posterBase64; 
          videoPreview.src = videoUrl;
          
          setTimeout(() => {
              videoPreview.style.display = 'block';
              previewImage.style.display = 'none'; 
              downloadButton.style.display = 'flex'; 
              dropArea.classList.add('disabled'); 

              statusEl.textContent = "✅ Selesai! Video siap di-preview dan diunduh.";
          }, 50);

          downloadButton.onclick = () => {
            const a = document.createElement("a");
            a.href = videoUrl;
            a.download = `video-${selectedResolution}-${durationInput.value}s.mp4`; 
            a.click();
          };

        } catch (err) {
          processingOverlay.style.display = 'none'; 
          statusEl.textContent = "❌ Terjadi kesalahan: " + err.message;
          dropArea.classList.remove('disabled'); 
          if (previewImage.src) {
              previewImage.style.display = 'block';
          }
        } finally {
          convertBtn.disabled = false;
        }
      };
      reader.readAsDataURL(selectedFile);
    };
  </script>
</body>
  </html>
